<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å™äº‹å¼•æ“åŸå‹ Â· {{ character.name }}</title>
<style>
  :root {
    --bg: #0d0f14;
    --panel: #151820;
    --border: #2a2d3a;
    --text: #c8cdd8;
    --dim: #5a5f70;
    --accent: #7c6af7;
    --green: #4ade80;
    --yellow: #fbbf24;
    --red: #f87171;
    --blue: #60a5fa;
    --pink: #f472b6;
    --teal: #2dd4bf;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; overflow: hidden; }

  /* â”€â”€ Layout â”€â”€ */
  .layout { display: grid; grid-template-columns: 1fr 420px; grid-template-rows: 48px 1fr; height: 100vh; gap: 0; }

  /* â”€â”€ Header â”€â”€ */
  .header { grid-column: 1/-1; display: flex; align-items: center; padding: 0 20px; gap: 16px;
    border-bottom: 1px solid var(--border); background: var(--panel); }
  .header h1 { font-size: 15px; font-weight: 600; color: var(--accent); letter-spacing: .05em; }
  .turn-badge { font-size: 12px; color: var(--dim); background: #1e2130; padding: 2px 10px; border-radius: 12px; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; margin-left: auto; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

  /* â”€â”€ Chat Column â”€â”€ */
  .chat-col { display: flex; flex-direction: column; border-right: 1px solid var(--border); overflow: hidden; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .msg { max-width: 85%; }
  .msg.user { align-self: flex-end; }
  .msg.assistant { align-self: flex-start; }
  .msg-bubble { padding: 12px 16px; border-radius: 14px; font-size: 14px; line-height: 1.65; white-space: pre-wrap; }
  .msg.user .msg-bubble { background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
  .msg.assistant .msg-bubble { background: var(--panel); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .msg-meta { font-size: 11px; color: var(--dim); margin-top: 4px; }
  .msg.user .msg-meta { text-align: right; }

  .chat-input { border-top: 1px solid var(--border); padding: 16px; display: flex; gap: 10px; }
  .chat-input textarea { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 10px;
    color: var(--text); padding: 10px 14px; font-size: 14px; resize: none; height: 44px; outline: none;
    transition: border-color .2s; }
  .chat-input textarea:focus { border-color: var(--accent); }
  .send-btn { background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 0 18px;
    cursor: pointer; font-size: 14px; font-weight: 600; transition: opacity .2s; }
  .send-btn:hover { opacity: .85; }
  .send-btn:disabled { opacity: .4; cursor: default; }

  /* â”€â”€ Debug Column â”€â”€ */
  .debug-col { display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
  .debug-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--panel); }
  .tab { padding: 10px 14px; font-size: 12px; cursor: pointer; color: var(--dim); border-bottom: 2px solid transparent;
    transition: all .2s; white-space: nowrap; }
  .tab.active { color: var(--text); border-bottom-color: var(--accent); }
  .debug-panels { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }

  /* â”€â”€ Debug Panels â”€â”€ */
  .d-panel { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .d-panel-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px;
    font-size: 11px; font-weight: 600; letter-spacing: .06em; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  .d-panel-body { padding: 10px 12px; font-size: 12px; line-height: 1.6; }

  /* Panel color themes */
  .p-perception .d-panel-header { background: #0f1a2a; color: var(--blue); }
  .p-director   .d-panel-header { background: #1a0f2a; color: var(--accent); }
  .p-performance .d-panel-header { background: #0a1a15; color: var(--green); }
  .p-neh        .d-panel-header { background: #1a1200; color: var(--yellow); }
  .p-state      .d-panel-header { background: #1a0a12; color: var(--pink); }

  .d-row { display: flex; gap: 8px; margin-bottom: 5px; }
  .d-key { color: var(--dim); min-width: 90px; flex-shrink: 0; }
  .d-val { color: var(--text); }
  .d-val.hi { color: var(--yellow); font-weight: 600; }
  .d-val.good { color: var(--green); }
  .d-val.warn { color: var(--red); }

  .bar-wrap { display: flex; align-items: center; gap: 8px; }
  .bar { height: 6px; border-radius: 3px; flex: 1; background: #1e2130; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 3px; transition: width .4s; }
  .bar-num { font-size: 11px; color: var(--dim); min-width: 28px; text-align: right; }

  .tag { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 10px; font-weight: 600;
    margin: 2px; background: #1e2130; color: var(--dim); border: 1px solid var(--border); }
  .tag.active { background: #1a1a2e; color: var(--accent); border-color: var(--accent); }
  .tag.fired { background: #2a1000; color: var(--yellow); border-color: var(--yellow); }

  .signal-list { display: flex; flex-wrap: wrap; gap: 4px; }

  .neh-event { background: #1a1200; border: 1px solid #3a2a00; border-radius: 6px; padding: 6px 10px; margin-bottom: 6px; }
  .neh-event .e-name { color: var(--yellow); font-weight: 600; font-size: 12px; }
  .neh-event .e-meta { color: var(--dim); font-size: 11px; }

  .director-note { background: #12101a; border-left: 3px solid var(--accent); padding: 8px 10px;
    font-size: 12px; color: var(--dim); font-style: italic; border-radius: 0 6px 6px 0; margin-top: 8px; }

  /* State bars */
  .state-section { margin-bottom: 10px; }
  .state-title { font-size: 10px; color: var(--dim); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; }

  .placeholder { color: var(--dim); font-size: 12px; text-align: center; padding: 20px; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Loading indicator */
  .typing { display: none; align-items: center; gap: 6px; padding: 8px 16px; }
  .typing.show { display: flex; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: bounce .8s infinite; }
  .dot:nth-child(2) { animation-delay: .15s; }
  .dot:nth-child(3) { animation-delay: .3s; }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
</style>
</head>
<body>
<div class="layout">

  <!-- Header -->
  <div class="header">
    <h1>ğŸ­ å™äº‹å¼•æ“åŸå‹ Â· <span id="char-name">{{ character.name }}</span></h1>
    <span class="turn-badge">ç¬¬ <span id="turn-num">0</span> è½®</span>
    <span id="status-dot" class="status-dot"></span>
  </div>

  <!-- Chat Column -->
  <div class="chat-col">
    <div class="chat-messages" id="chat-messages">
      <div class="msg assistant">
        <div class="msg-bubble">ç³»ç»Ÿåˆå§‹åŒ–ä¸­â€¦â€¦</div>
      </div>
    </div>
    <div class="typing" id="typing-indicator">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      <span style="font-size:12px;color:var(--dim)">{{ character.name }} æ€è€ƒä¸­</span>
    </div>
    <div class="chat-input">
      <textarea id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦ (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)" rows="1"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>
  </div>

  <!-- Debug Column -->
  <div class="debug-col">
    <div class="debug-tabs">
      <div class="tab active" onclick="switchTab('overview')">æ€»è§ˆ</div>
      <div class="tab" onclick="switchTab('perception')">æ„ŸçŸ¥å±‚</div>
      <div class="tab" onclick="switchTab('director')">å¯¼æ¼”å±‚</div>
      <div class="tab" onclick="switchTab('neh')">NEH</div>
      <div class="tab" onclick="switchTab('state')">çŠ¶æ€è½´</div>
    </div>
    <div class="debug-panels" id="debug-panels">
      <div class="placeholder">ç­‰å¾…ç¬¬ä¸€æ¡æ¶ˆæ¯â€¦</div>
    </div>
  </div>
</div>

<script>
let SESSION_ID = null;
let currentTab = 'overview';
let lastDebug = null;
let lastState = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initSession() {
  const res = await fetch('/api/new_session', { method: 'POST',
    headers: {'Content-Type': 'application/json'}, body: '{}' });
  const data = await res.json();
  SESSION_ID = data.session_id;
  lastState = data.state;

  // Show welcome
  const msgs = document.getElementById('chat-messages');
  msgs.innerHTML = '';
  appendMsg('assistant', `ä½ å¥½ã€‚\n\næˆ‘åˆšåˆšé†’æ¥â€¦â€¦è¿™é‡Œçš„å…‰æœ‰ç‚¹é™Œç”Ÿã€‚\n\nä½ æ˜¯è°ï¼Ÿ`, 0);
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const msg = input.value.trim();
  if (!msg || !SESSION_ID) return;

  input.value = '';
  input.style.height = '44px';

  appendMsg('user', msg, null);
  setLoading(true);

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ session_id: SESSION_ID, message: msg })
    });
    const data = await res.json();

    if (data.error) {
      appendMsg('assistant', `âš ï¸ ${data.error}`, null);
    } else {
      appendMsg('assistant', data.response, data.turn);
      document.getElementById('turn-num').textContent = data.turn;
      lastDebug = data.debug;
      lastState = data.state;
      renderDebug(currentTab);
    }
  } catch(e) {
    appendMsg('assistant', 'âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡', null);
  }
  setLoading(false);
}

function appendMsg(role, text, turn) {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  const turnMeta = turn ? `ç¬¬ ${turn} è½®` : '';
  div.innerHTML = `
    <div class="msg-bubble">${escHtml(text)}</div>
    ${turnMeta ? `<div class="msg-meta">${turnMeta}</div>` : ''}`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function setLoading(on) {
  document.getElementById('typing-indicator').className = on ? 'typing show' : 'typing';
  document.getElementById('send-btn').disabled = on;
}

// â”€â”€ Input auto-resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('msg-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
document.getElementById('msg-input').addEventListener('input', function() {
  this.style.height = '44px';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach((el, i) => {
    el.classList.toggle('active', ['overview','perception','director','neh','state'][i] === tab);
  });
  renderDebug(tab);
}

// â”€â”€ Debug Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDebug(tab) {
  const el = document.getElementById('debug-panels');
  if (!lastDebug) { el.innerHTML = '<div class="placeholder">ç­‰å¾…ç¬¬ä¸€æ¡æ¶ˆæ¯â€¦</div>'; return; }

  switch(tab) {
    case 'overview':   el.innerHTML = renderOverview(); break;
    case 'perception': el.innerHTML = renderPerception(); break;
    case 'director':   el.innerHTML = renderDirector(); break;
    case 'neh':        el.innerHTML = renderNEH(); break;
    case 'state':      el.innerHTML = renderState(); break;
  }
}

// â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOverview() {
  const p = lastDebug.perception || {};
  const d = lastDebug.director || {};
  const perf = lastDebug.performance || {};
  const neh = lastDebug.neh_trigger || {};
  const axes = lastState?.axes || {};

  return `
  <div class="d-panel p-perception">
    <div class="d-panel-header">âš¡ æ„ŸçŸ¥å±‚</div>
    <div class="d-panel-body">
      ${row('æ„å›¾', p.user_intent)} ${row('æƒ…ç»ª', p.emotional_tone)} ${row('å‚ä¸åº¦', p.engagement_level)}
      ${row('å™äº‹æœºä¼š', p.narrative_opportunity, 'hi')}
    </div>
  </div>
  <div class="d-panel p-director">
    <div class="d-panel-header">ğŸ¬ å¯¼æ¼”å±‚</div>
    <div class="d-panel-body">
      ${row('æŒ‡ä»¤', d.narrative_directive, 'hi')}
      ${row('å¼ åŠ›æŠ€æœ¯', d.tension_technique)}
      ${row('çº¿ç¨‹ç„¦ç‚¹', d.thread_action?.focus + ' Â· ' + d.thread_action?.action)}
    </div>
  </div>
  <div class="d-panel p-performance">
    <div class="d-panel-header">ğŸ­ è¡¨ç°å±‚</div>
    <div class="d-panel-body">
      ${row('åº”ç”¨æŒ‡ä»¤', perf.directive_applied)}
      ${row('æŠ€æœ¯', perf.technique_used)}
    </div>
  </div>
  <div class="d-panel p-state">
    <div class="d-panel-header">ğŸ“Š çŠ¶æ€å¿«ç…§</div>
    <div class="d-panel-body">
      ${barRow('å¼ åŠ›', axes.tension, '#f87171')}
      ${barRow('äº²å¯†åº¦', axes.intimacy, '#f472b6')}
      ${barRow('èƒ½é‡', axes.energy, '#60a5fa')}
      ${row('æƒ…ç»ª', axes.emotion?.label + ' (' + axes.emotion?.intensity + ')')}
      ${row('åŠ¨é‡', lastState?.momentum?.direction + ' Â· ' + lastState?.momentum?.pace)}
    </div>
  </div>
  ${neh.should_trigger ? `
  <div class="d-panel p-neh">
    <div class="d-panel-header">âš¡ NEH è§¦å‘</div>
    <div class="d-panel-body">
      <div class="d-row"><div class="d-val warn">ğŸ”¥ å·²è§¦å‘ï¼š${neh.event_name}</div></div>
      ${row('åŸå› ', neh.trigger_reason)}
    </div>
  </div>` : ''}`;
}

// â”€â”€ Perception â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPerception() {
  const p = lastDebug.perception || {};
  if (p.error) return `<div class="placeholder">é”™è¯¯ï¼š${p.error}</div>`;
  return `
  <div class="d-panel p-perception">
    <div class="d-panel-header">âš¡ æ„ŸçŸ¥å±‚å®Œæ•´è¾“å‡º</div>
    <div class="d-panel-body">
      ${row('ç”¨æˆ·æ„å›¾', p.user_intent, 'hi')}
      ${row('æƒ…ç»ªè‰²å½©', p.emotional_tone)}
      ${row('å‚ä¸åº¦', p.engagement_level)}
      ${row('è·Ÿéšç±»å‹', p.follow_type)}
      ${row('å¼ åŠ›å»ºè®®', p.tension_hint)}
      <div class="d-row"><div class="d-key">å…³é”®ä¿¡å·</div><div class="signal-list">${
        (p.key_signals||[]).map(s=>`<span class="tag active">${escHtml(s)}</span>`).join('')
      }</div></div>
      <div class="d-row" style="margin-top:8px">
        <div class="d-key">å™äº‹æœºä¼š</div>
        <div class="d-val hi">${escHtml(p.narrative_opportunity||'')}</div>
      </div>
    </div>
  </div>`;
}

// â”€â”€ Director â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDirector() {
  const d = lastDebug.director || {};
  if (d.error) return `<div class="placeholder">é”™è¯¯ï¼š${d.error}</div>`;
  const patch = d.state_patch || {};
  const axes = patch.axes || {};
  return `
  <div class="d-panel p-director">
    <div class="d-panel-header">ğŸ¬ å¯¼æ¼”å±‚å®Œæ•´è¾“å‡º</div>
    <div class="d-panel-body">
      <div class="d-row"><div class="d-key">æ ¸å¿ƒæŒ‡ä»¤</div><div class="d-val hi">${escHtml(d.narrative_directive||'')}</div></div>
      ${row('å¼ åŠ›æŠ€æœ¯', d.tension_technique)}
      ${row('çº¿ç¨‹ç„¦ç‚¹', d.thread_action?.focus)}
      ${row('çº¿ç¨‹åŠ¨ä½œ', d.thread_action?.action)}
      ${row('NEHå»ºè®®', d.neh_trigger_recommendation)}
      <div style="margin-top:10px" class="state-title">çŠ¶æ€å˜æ›´ (PATCH)</div>
      ${Object.keys(axes).length ? Object.entries(axes).map(([k,v])=>row(k, JSON.stringify(v))).join('') : '<div class="d-row"><div class="d-val" style="color:var(--dim)">æ— çŠ¶æ€å˜æ›´</div></div>'}
      ${row('å˜æ›´æ‘˜è¦', patch.patch_summary)}
      ${d.director_note ? `<div class="director-note">ğŸ’­ ${escHtml(d.director_note)}</div>` : ''}
    </div>
  </div>`;
}

// â”€â”€ NEH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNEH() {
  const trigger = lastDebug.neh_trigger || {};
  const predict = lastDebug.neh_predict;
  const fired = lastDebug.neh_fired;
  const pool = lastState?.event_pool || {};

  return `
  <div class="d-panel p-neh">
    <div class="d-panel-header">ğŸ”® NEH Trigger</div>
    <div class="d-panel-body">
      ${row('è§¦å‘åˆ¤æ–­', trigger.should_trigger ? 'ğŸ”¥ è§¦å‘' : 'â³ ç­‰å¾…', trigger.should_trigger ? 'warn' : '')}
      ${row('ç›®æ ‡äº‹ä»¶', trigger.event_name || 'â€”')}
      ${row('å¾…å‘äº‹ä»¶æ•°', trigger.pending_count)}
      ${row('åˆ¤æ–­ç†ç”±', trigger.trigger_reason)}
      ${fired ? `<div class="d-row" style="margin-top:8px"><div class="d-val warn">âœ… å·²è§¦å‘ï¼š${escHtml(fired.name||'')} â€” ${escHtml(fired.description||'')}</div></div>` : ''}
    </div>
  </div>
  ${predict ? `
  <div class="d-panel p-neh">
    <div class="d-panel-header">ğŸ”® NEH Predictorï¼ˆæœ¬è½®æ–°å¢ï¼‰</div>
    <div class="d-panel-body">
      ${(predict.events||[]).map(ev=>`
        <div class="neh-event">
          <div class="e-name">${escHtml(ev.name||'')} <span style="color:var(--dim);font-size:10px">P${ev.priority}</span></div>
          <div class="e-meta">${escHtml(ev.description||'')} Â· è½®æ¬¡ ${ev.trigger_turn_min}-${ev.trigger_turn_max}</div>
        </div>`).join('')}
    </div>
  </div>` : ''}
  <div class="d-panel p-neh">
    <div class="d-panel-header">ğŸ“¦ äº‹ä»¶æ± </div>
    <div class="d-panel-body">
      <div class="state-title">å¾…è§¦å‘ (${(pool.pending||[]).length})</div>
      ${(pool.pending||[]).map(ev=>`
        <div class="neh-event">
          <div class="e-name">${escHtml(ev.name||'')} <span style="color:var(--dim);font-size:10px">P${ev.priority}</span></div>
          <div class="e-meta">${escHtml(ev.trigger_condition||'')}</div>
        </div>`).join('') || '<div class="d-row"><div class="d-val" style="color:var(--dim)">æš‚æ— å¾…è§¦å‘äº‹ä»¶</div></div>'}
      <div class="state-title" style="margin-top:8px">å·²è§¦å‘ (${(pool.triggered||[]).length})</div>
      ${(pool.triggered||[]).map(ev=>`
        <span class="tag fired">${escHtml(ev.name||'')} @T${ev.fired_at_turn}</span>`).join('') || '<span style="color:var(--dim);font-size:11px">æš‚æ— </span>'}
    </div>
  </div>`;
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderState() {
  const axes = lastState?.axes || {};
  const mom = lastState?.momentum || {};
  const threads = lastState?.threads || [];
  const meta = lastState?.meta || {};

  return `
  <div class="d-panel p-state">
    <div class="d-panel-header">ğŸ“Š å…­è½´çŠ¶æ€</div>
    <div class="d-panel-body">
      ${barRow('å¼ åŠ›', axes.tension, '#f87171')}
      ${barRow('äº²å¯†åº¦', axes.intimacy, '#f472b6')}
      ${barRow('å™äº‹èƒ½é‡', axes.energy, '#60a5fa')}
      ${barRow('æƒ…ç»ªå¼ºåº¦', axes.emotion?.intensity, '#fbbf24')}
      ${row('æƒ…ç»ªæ ‡ç­¾', axes.emotion?.label)}
      ${row('æ ¸å¿ƒé©±åŠ¨', axes.drive)}
      <div class="state-title" style="margin-top:10px">ä¿¡æ¯é¢çº±</div>
      <div class="d-row"><div class="d-key">å·²æ­ç¤º</div><div class="signal-list">${
        (axes.info_veil?.revealed||['æ— ']).map(s=>`<span class="tag active">${escHtml(s)}</span>`).join('')
      }</div></div>
      <div class="d-row"><div class="d-key">éšè—ä¸­</div><div class="signal-list">${
        (axes.info_veil?.hidden||[]).map(s=>`<span class="tag">${escHtml(s)}</span>`).join('')
      }</div></div>
    </div>
  </div>
  <div class="d-panel p-state">
    <div class="d-panel-header">âš¡ å™äº‹åŠ¨é‡</div>
    <div class="d-panel-body">
      ${row('æ–¹å‘', mom.direction)} ${row('èŠ‚å¥', mom.pace)} ${row('è¿ç»­è½®æ¬¡', mom.streak)}
      ${row('å˜æ›´æ‘˜è¦', meta.last_patch_summary, 'hi')}
    </div>
  </div>
  <div class="d-panel p-state">
    <div class="d-panel-header">ğŸ§µ çº¿ç¨‹æ±  (${threads.length})</div>
    <div class="d-panel-body">
      ${threads.length ? threads.map(t=>`
        <div class="neh-event" style="border-color:#2a1a3a">
          <div class="e-name" style="color:var(--pink)">${escHtml(t.name||'')} <span style="color:var(--dim);font-size:10px">[${t.status}]</span></div>
          <div class="e-meta">è¿›åº¦ ${t.progress||0}%</div>
        </div>`).join('') : '<div class="d-val" style="color:var(--dim)">æš‚æ— æ´»è·ƒçº¿ç¨‹</div>'}
    </div>
  </div>`;
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function row(key, val, cls='') {
  if (val === undefined || val === null) return '';
  return `<div class="d-row"><div class="d-key">${escHtml(key)}</div><div class="d-val ${cls}">${escHtml(String(val))}</div></div>`;
}
function barRow(label, val, color) {
  val = val || 0;
  return `<div class="d-row">
    <div class="d-key">${label}</div>
    <div class="bar-wrap" style="flex:1">
      <div class="bar"><div class="bar-fill" style="width:${val}%;background:${color}"></div></div>
      <div class="bar-num">${val}</div>
    </div>
  </div>`;
}
function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initSession();
</script>
</body>
</html>
